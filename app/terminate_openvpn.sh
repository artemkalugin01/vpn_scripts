#!/bin/bash
remove="Y"
if [[ "$remove" =~ ^[yY]$ ]]; then
    port=$(grep '^port ' /etc/openvpn/server/server.conf | cut -d " " -f 2)
    protocol=$(grep '^proto ' /etc/openvpn/server/server.conf | cut -d " " -f 2)
    if systemctl is-active --quiet firewalld.service; then
        ip=$(firewall-cmd --direct --get-rules ipv4 nat POSTROUTING | grep '\-s 10.8.0.0/24 '"'"'!'"'"' -d 10.8.0.0/24' | grep -oE '[^ ]+$')
        # Using both permanent and not permanent rules to avoid a firewalld reload.
        firewall-cmd --remove-port="$port"/"$protocol"
        firewall-cmd --zone=trusted --remove-source=10.8.0.0/24
        firewall-cmd --permanent --remove-port="$port"/"$protocol"
        firewall-cmd --permanent --zone=trusted --remove-source=10.8.0.0/24
        firewall-cmd --direct --remove-rule ipv4 nat POSTROUTING 0 -s 10.8.0.0/24 ! -d 10.8.0.0/24 -j SNAT --to "$ip"
        firewall-cmd --permanent --direct --remove-rule ipv4 nat POSTROUTING 0 -s 10.8.0.0/24 ! -d 10.8.0.0/24 -j SNAT --to "$ip"
        if grep -qs "server-ipv6" /etc/openvpn/server/server.conf; then
            ip6=$(firewall-cmd --direct --get-rules ipv6 nat POSTROUTING | grep '\-s fddd:1194:1194:1194::/64 '"'"'!'"'"' -d fddd:1194:1194:1194::/64' | grep -oE '[^ ]+$')
            firewall-cmd --zone=trusted --remove-source=fddd:1194:1194:1194::/64
            firewall-cmd --permanent --zone=trusted --remove-source=fddd:1194:1194:1194::/64
            firewall-cmd --direct --remove-rule ipv6 nat POSTROUTING 0 -s fddd:1194:1194:1194::/64 ! -d fddd:1194:1194:1194::/64 -j SNAT --to "$ip6"
            firewall-cmd --permanent --direct --remove-rule ipv6 nat POSTROUTING 0 -s fddd:1194:1194:1194::/64 ! -d fddd:1194:1194:1194::/64 -j SNAT --to "$ip6"
        fi
    else
        systemctl disable --now openvpn-iptables.service
        rm -f /etc/systemd/system/openvpn-iptables.service
    fi
    if sestatus 2>/dev/null | grep "Current mode" | grep -q "enforcing" && [[ "$port" != 1194 ]]; then
        semanage port -d -t openvpn_port_t -p "$protocol" "$port"
    fi
    systemctl disable --now openvpn-server@server.service
    rm -f /etc/systemd/system/openvpn-server@server.service.d/disable-limitnproc.conf
    rm -f /etc/sysctl.d/99-openvpn-forward.conf
    if [[ "$os" = "debian" || "$os" = "ubuntu" ]]; then
        rm -rf /etc/openvpn/server
        apt-get remove --purge -y openvpn
    else
        yum remove -y openvpn
        rm -rf /etc/openvpn/server
    fi
    echo
    echo "OpenVPN removed!"
else
    echo
    echo "OpenVPN removal aborted!"
fi
exit
;;